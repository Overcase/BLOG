<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Express+MongoDB建站 | Linhf</title>
    <meta name="description" content="永远不要忘记你的欲望和恐惧 ">
    <link rel="icon" href="/logo.png">
    <meta name="Express" content="Recorded the process of express build"><meta name="Express" content="记录使用express建站的过程">
    <link rel="preload" href="/assets/css/styles.7fa88ce5.css" as="style"><link rel="preload" href="/assets/js/app.7fa88ce5.js" as="script"><link rel="preload" href="/assets/css/styles.7fa88ce5.css" as="style"><link rel="preload" href="/assets/js/34.8cd6cd5e.js" as="script"><link rel="prefetch" href="/assets/css/1.styles.eeb43671.css"><link rel="prefetch" href="/assets/css/2.styles.50882dc4.css"><link rel="prefetch" href="/assets/js/1.eeb43671.js"><link rel="prefetch" href="/assets/js/10.decc3d39.js"><link rel="prefetch" href="/assets/js/11.0a3b1f05.js"><link rel="prefetch" href="/assets/js/12.b6be7e7b.js"><link rel="prefetch" href="/assets/js/13.44149539.js"><link rel="prefetch" href="/assets/js/14.99a5558f.js"><link rel="prefetch" href="/assets/js/15.0ac7724e.js"><link rel="prefetch" href="/assets/js/16.1691e973.js"><link rel="prefetch" href="/assets/js/17.ae866f11.js"><link rel="prefetch" href="/assets/js/18.8cafb262.js"><link rel="prefetch" href="/assets/js/19.933374fc.js"><link rel="prefetch" href="/assets/js/2.50882dc4.js"><link rel="prefetch" href="/assets/js/20.f4444e8f.js"><link rel="prefetch" href="/assets/js/21.503eae05.js"><link rel="prefetch" href="/assets/js/22.9be6e08d.js"><link rel="prefetch" href="/assets/js/23.29ea216f.js"><link rel="prefetch" href="/assets/js/24.c50c9b98.js"><link rel="prefetch" href="/assets/js/25.7dc290ba.js"><link rel="prefetch" href="/assets/js/26.33e4236f.js"><link rel="prefetch" href="/assets/js/27.150a023a.js"><link rel="prefetch" href="/assets/js/28.facbdbed.js"><link rel="prefetch" href="/assets/js/29.2c9fc6a3.js"><link rel="prefetch" href="/assets/js/3.852f1526.js"><link rel="prefetch" href="/assets/js/30.98eabcc3.js"><link rel="prefetch" href="/assets/js/31.0fb90340.js"><link rel="prefetch" href="/assets/js/32.c3cc4dd3.js"><link rel="prefetch" href="/assets/js/33.6fdaef1e.js"><link rel="prefetch" href="/assets/js/35.1b190fa1.js"><link rel="prefetch" href="/assets/js/36.59a11581.js"><link rel="prefetch" href="/assets/js/37.3adea853.js"><link rel="prefetch" href="/assets/js/38.b8d84bbe.js"><link rel="prefetch" href="/assets/js/39.d9d3217b.js"><link rel="prefetch" href="/assets/js/4.c5af5a6d.js"><link rel="prefetch" href="/assets/js/40.3d776593.js"><link rel="prefetch" href="/assets/js/41.295d7d85.js"><link rel="prefetch" href="/assets/js/42.22e8987a.js"><link rel="prefetch" href="/assets/js/43.2fdc4cc1.js"><link rel="prefetch" href="/assets/js/44.50360408.js"><link rel="prefetch" href="/assets/js/5.bdce62ca.js"><link rel="prefetch" href="/assets/js/6.3a83f800.js"><link rel="prefetch" href="/assets/js/7.bfa3b351.js"><link rel="prefetch" href="/assets/js/8.a46fdee8.js"><link rel="prefetch" href="/assets/js/9.57d36df0.js">
    <link rel="stylesheet" href="/assets/css/1.styles.eeb43671.css"><link rel="stylesheet" href="/assets/css/2.styles.50882dc4.css"><link rel="stylesheet" href="/assets/css/styles.7fa88ce5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="wrap"><div class="theme-container container no-sidebar"><header class="navbar"><div class="nav-header"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" class="logo"> <span class="site-name can-hide">
        Linhf
      </span></a> <nav class="nav-links can-hide"><div class="nav-item"><a href="/live/" class="nav-link">Home</a></div><div class="nav-item"><a href="/tags/" class="nav-link">TAGS</a></div><div class="nav-item"><a href="https://github.com/Overcase" target="_blank" rel="noopener noreferrer" class="nav-link">GitHub</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于我</a></div> <!----></nav> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/live/" class="nav-link">Home</a></div><div class="nav-item"><a href="/tags/" class="nav-link">TAGS</a></div><div class="nav-item"><a href="https://github.com/Overcase" target="_blank" rel="noopener noreferrer" class="nav-link">GitHub</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于我</a></div> <!----></nav> <!----></div> <div class="page-container"><div><div class="page card"><div class="content-header"><h1 class="page-title" style="color:#ac3e40;">
        Express+MongoDB建站
      </h1> <span class="page-timestamp">2019-02-25</span></div> <div class="content"><p>本篇记录使用express+MongoDB建站的过程
</p> <h2 id="node-js"><a href="#node-js" aria-hidden="true" class="header-anchor">#</a> Node.js</h2> <h3 id="node-版本管理"><a href="#node-版本管理" aria-hidden="true" class="header-anchor">#</a> Node 版本管理</h3> <p>可以使用 n 或 nvm 来管理</p> <p>nrm 是一个管理 npm 源的工具</p> <h3 id="require"><a href="#require" aria-hidden="true" class="header-anchor">#</a> require</h3> <p>主要用途是加载代码</p> <ul><li>require 可加载 .js、.json 和 .node 后缀的文件</li> <li>require 的过程是同步的，所以这样是错误的:</li></ul> <div class="language- extra-class"><pre class="language-text"><code>setTimeout(() =&gt; {
  module.exports = { a: 'hello' };
}, 0);
</code></pre></div><p>在使用 require 时要避免循环引用</p> <h3 id="exports-和-module-exports"><a href="#exports-和-module-exports" aria-hidden="true" class="header-anchor">#</a> exports 和 module.exports</h3> <p>exports 和 module.exports 用来导出代码
exports 和 module.exports 的区别</p> <ul><li>module.exports 初始值为一个空对象 {}</li> <li>exports 是指向的 module.exports 的引用</li> <li>require() 返回的是 module.exports 而不是 exports</li></ul> <blockquote><p>建议直接使用 module.exports</p></blockquote> <h2 id="mongodb"><a href="#mongodb" aria-hidden="true" class="header-anchor">#</a> MongoDB</h2> <p>见 MongoDB  安装记录 Markdown</p> <h2 id="模板引擎"><a href="#模板引擎" aria-hidden="true" class="header-anchor">#</a> 模板引擎</h2> <h3 id="ejs"><a href="#ejs" aria-hidden="true" class="header-anchor">#</a> ejs</h3> <p><code>&lt;% code %&gt;：运行 JavaScript 代码，不输出</code></p> <p><code>&lt;%= code %&gt;：显示转义后的 HTML内容</code></p> <p><code>&lt;%- code %&gt;：显示原始 HTML 内容</code></p> <blockquote><p>注意：&lt;%= code %&gt; 和 &lt;%- code %&gt; 都可以是 JavaScript 表达式生成的字符串，当变量 code 为普通字符串时，两者没有区别。当 code 比如为 </p><h1>hello</h1> 这种字符串时，&lt;%= code %&gt; 会原样输出 <h1>hello</h1>，而 &lt;%- code %&gt; 则会显示 H1 大的 hello 字符串。<p></p></blockquote> <h3 id="includes"><a href="#includes" aria-hidden="true" class="header-anchor">#</a> includes</h3> <div class="language- extra-class"><pre class="language-text"><code>&lt;%- include('header') %&gt;
  &lt;h1&gt;&lt;%= name.toUpperCase() %&gt;&lt;/h1&gt;
  &lt;p&gt;hello, &lt;%= name %&gt;&lt;/p&gt;
&lt;%- include('footer') %&gt;
</code></pre></div><p>我们将原来的 users.ejs 拆成出了 header.ejs 和 footer.ejs，并在 users.ejs 通过 ejs 内置的 include 方法引入，从而实现了跟以前一个模板文件相同的功能。</p> <p><strong>小提示：拆分模板组件通常有两个好处：</strong></p> <ol><li>模板可复用，减少重复代码</li> <li>主模板结构清晰</li></ol> <blockquote><p>注意：要用 &lt;%- include('header') %&gt; 而不是 &lt;%= include('header') %&gt;</p></blockquote> <h2 id="中间件"><a href="#中间件" aria-hidden="true" class="header-anchor">#</a> 中间件</h2> <p>通过 app.use 加载中间件，在中间件中通过 next 将请求传递到下一个中间件，next 可接受一个参数接收错误信息，如果使用了 next(error)，则会返回错误而不会传递到下一个中间件</p> <h2 id="目录结构"><a href="#目录结构" aria-hidden="true" class="header-anchor">#</a> 目录结构</h2> <p>models: 存放操作数据库的文件
public: 存放静态文件，如样式、图片等
routes: 存放路由文件
views: 存放模板文件
index.js: 程序主文件
package.json: 存储项目名、描述、作者、依赖等等信息</p> <blockquote><p>小提示：不知读者发现了没有，我们遵循了 MVC（模型(model)－视图(view)－控制器(controller/route)） 的开发模式。</p></blockquote> <h2 id="模块"><a href="#模块" aria-hidden="true" class="header-anchor">#</a> 模块</h2> <ol><li>express: web 框架</li> <li>express-session: session 中间件</li> <li>connect-mongo: 将 session 存储于 mongodb，结合 express-session 使用</li> <li>connect-flash: 页面通知提示的中间件，基于 session 实现</li> <li>ejs: 模板</li> <li>express-formidable: 接收表单及文件的上传中间件</li> <li>config-lite: 读取配置文件</li> <li>marked: markdown 解析</li> <li>moment: 时间格式化</li> <li>mongolass: mongodb 驱动</li> <li>objectid-to-timestamp: 根据 ObjectId 生成时间戳</li> <li>sha1: sha1 加密，用于密码加密</li> <li>winston: 日志</li> <li>express-winston: 基于 winston 的用于 express 的日志中间件</li></ol> <h2 id="app-locals-和-res-locals"><a href="#app-locals-和-res-locals" aria-hidden="true" class="header-anchor">#</a> app.locals 和 res.locals</h2> <p>在调用 res.render 的时候，express 合并（merge）了 3 处的结果后传入要渲染的模板，优先级：res.render 传入的对象&gt; res.locals 对象 &gt; app.locals 对象，所以 app.locals 和 res.locals 几乎没有区别，都用来渲染模板，使用上的区别在于：<strong>app.locals 上通常挂载常量信息（如博客名、描述、作者信息），res.locals 上通常挂载变量信息，即每次请求可能的值都不一样（如请求者信息，res.locals.user = req.session.user）。</strong></p> <h2 id="错误处理"><a href="#错误处理" aria-hidden="true" class="header-anchor">#</a> 错误处理</h2> <p>我们使用 <code>winston</code> 和 <code>express-winston</code> 记录日志</p> <blockquote><p>需要注意的是：记录正常请求日志的中间件要放到 routes(app) 之前，记录错误请求日志的中间件要放到 routes(app) 之后。</p></blockquote></div> <!----> <!----></div> <!----></div> <!----></div> <div class="tool-group"><!----></div></div> <!----></div> <div class="background-mask" style="background:#f6f6f6;"></div></div></div>
    <script src="/assets/js/34.8cd6cd5e.js" defer></script><script src="/assets/js/app.7fa88ce5.js" defer></script>
  </body>
</html>
